---
import { Image } from "astro:assets";
import type { ImageMetadata } from 'astro';
import StatsCircle from '../assets/homepage/circle4.svg';

// Local stats icons
import IconSchool from '../assets/homepage/stats/school.svg';
import IconSeason from '../assets/homepage/stats/seanson.svg';
import IconEpisode from '../assets/homepage/stats/episode.svg';
import IconRecord from '../assets/homepage/stats/record.svg';
import IconKids from '../assets/homepage/stats/kids.svg';
import IconClass from '../assets/homepage/stats/class.svg';
import IconSpotify from '../assets/homepage/stats/spotifyclick.svg';
// Stats counter component with icons - matching original WordPress design
interface Stat {
  value: number;
  label: string;
  suffix?: string;
  icon: ImageMetadata;
}

const stats: Stat[] = [
  { value: 6, label: '合作國小', suffix: '間', icon: IconSchool },
  { value: 5, label: '發行季數', suffix: '季', icon: IconSeason },
  { value: 50, label: '發行集數', suffix: '集', icon: IconEpisode },
  { value: 100, label: '進班錄音', suffix: '次', icon: IconRecord },
  { value: 500, label: '小朋友參與錄音', suffix: '位', icon: IconKids },
  { value: 30, label: '班級參與', suffix: '班', icon: IconClass },
  { value: 600, label: 'Spotify 點擊次數', suffix: '次', icon: IconSpotify },
];
---

<section class="py-16 bg-white">
  <div class="container mx-auto px-4">
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-8 text-center">
      {stats.map((stat, index) => (
        <div 
          class="flex flex-col items-center animate-fade-in"
          style={`animation-delay: ${index * 0.1}s`}
        >
          <!-- Icon with spinning circle decoration -->
          <div class="relative w-24 h-24 flex items-center justify-center mb-4">
            <Image
              src={StatsCircle}
              class="absolute inset-0 w-full h-full animate-spin-slow" 
              alt=""
            />
            <Image
              src={stat.icon}
              width={48}
              height={48}
              class="w-12 h-12 relative z-10"
              alt={stat.label}
            />
          </div>
          
          <!-- Counter value -->
          <h3 class="text-3xl font-bold text-primary">
            <span class="counter" data-target={stat.value}>0</span>
            <span class="text-sm text-dark">{stat.suffix}</span>
          </h3>
          <p class="text-sm text-gray-500 mt-1">{stat.label}</p>
        </div>
      ))}
    </div>
  </div>
</section>

<style>
  @keyframes spin-slow {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  .animate-spin-slow {
    animation: spin-slow 20s linear infinite;
  }
</style>

<script>
  // Intersection Observer for counter animation
  const observerOptions: IntersectionObserverInit = {
    threshold: 0.5,
    rootMargin: '0px',
  };

  const counters = document.querySelectorAll('.counter');
  let animated = false;

  const animateCounter = (counter: Element): void => {
    const target = parseInt(counter.getAttribute('data-target') || '0', 10);
    const duration = 2000; // 2 seconds
    const step = target / (duration / 16); // 60fps
    let current = 0;

    const updateCounter = (): void => {
      current += step;
      if (current < target) {
        counter.textContent = Math.floor(current).toLocaleString();
        requestAnimationFrame(updateCounter);
      } else {
        counter.textContent = target.toLocaleString();
      }
    };

    updateCounter();
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting && !animated) {
        animated = true;
        counters.forEach(animateCounter);
      }
    });
  }, observerOptions);

  // Observe the first counter's parent section
  const statsSection = document.querySelector('.counter')?.closest('section');
  if (statsSection) {
    observer.observe(statsSection);
  }
</script>
