---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Hero from '../components/Hero.astro';
import Stats from '../components/Stats.astro';
import NewsSection from '../components/NewsSection.astro';
import About from '../components/About.astro';
import Footer from '../components/Footer.astro';

import type { ImageMetadata } from 'astro';

interface NewsMeta {
  title: string;
  excerpt: string;
  date: string;
  slug: string;
  category?: string;
}

type NewsPageModule = {
  CoverImg?: ImageMetadata;
  newsMeta?: NewsMeta;
};

const newsPages = import.meta.glob<NewsPageModule>('./news/*.astro', { eager: true });

const toComparableDate = (date: string): number => {
  const normalized = date.replace(/\./g, '-');
  const ms = Date.parse(normalized);
  return Number.isNaN(ms) ? 0 : ms;
};

const recentNews = Object.values(newsPages)
  .map((mod) => {
    if (!mod.newsMeta) return null;
    return {
      title: mod.newsMeta.title,
      excerpt: mod.newsMeta.excerpt,
      date: mod.newsMeta.date,
      slug: mod.newsMeta.slug,
      image: mod.CoverImg?.src,
    };
  })
  .filter((item): item is NonNullable<typeof item> => item !== null)
  .sort((a, b) => toComparableDate(b!.date) - toComparableDate(a!.date))
  .slice(0, 3);
---

<Layout title="童心。同享 We Care We Share">
  <Header />
  <main class="pt-20">
    <Hero />
    <Stats />
    <NewsSection news={recentNews} />
    <About />
  </main>
  <Footer />
</Layout>